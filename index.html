<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sri Lanka Grid Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .result { margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Sri Lanka Grid Converter</h2>
  <p>Enter coordinates (Latitude, Longitude in decimal degrees or DMS)</p>
  
  <label>Latitude: <input type="text" id="lat" placeholder="e.g., 7.8731 or 7°52'23&quot;N"></label>
  <label>Longitude: <input type="text" id="lon" placeholder="e.g., 80.7718 or 80°46'18&quot;E"></label>
  
  <button onclick="convert()">Convert</button>
  
  <label>Grid Reference Precision:</label>
  <label><input type="radio" name="gr" value="4"> 4-figure</label>
  <label><input type="radio" name="gr" value="6" checked> 6-figure</label>
  <label><input type="radio" name="gr" value="8"> 8-figure</label>

  <div id="output" class="result"></div>
  
  <script>
    // Define projections
    const kandawala = "+proj=tmerc +lat_0=0 +lon_0=80.77171333333333 +k=1.000000 +x_0=200000 +y_0=200000 +ellps=evrst30 +units=m +no_defs";
    const sld99 = "+proj=tmerc +lat_0=0 +lon_0=80.77166666666666 +k=0.9999238418 +x_0=200000 +y_0=200000 +ellps=WGS84 +towgs84=-0.293,766.95,87.713,0,0,0,0 +units=m +no_defs";
    const utm44n = "+proj=utm +zone=44 +datum=WGS84 +units=m +no_defs";

    function parseDMS(input) {
      if (!isNaN(input)) return parseFloat(input);
      let parts = input.match(/(\d+)[°:\s](\d+)?[':\s]?([\d.]+)?\"?\s*([NSEW])?/i);
      if (!parts) return NaN;
      let deg = parseFloat(parts[1]) || 0;
      let min = parseFloat(parts[2]) || 0;
      let sec = parseFloat(parts[3]) || 0;
      let dir = parts[4] || null;
      let val = deg + (min/60) + (sec/3600);
      if (dir && /SW/.test(dir.toUpperCase())) val *= -1;
      return val;
    }

    function makeGR(easting, northing, figures) {
      // Remove 100 km grid square, keep last part
      let e = Math.floor(easting % 100000);
      let n = Math.floor(northing % 100000);

      let digits = figures/2;
      let eStr = Math.floor(e / Math.pow(10, 5-digits)).toString().padStart(digits, "0");
      let nStr = Math.floor(n / Math.pow(10, 5-digits)).toString().padStart(digits, "0");

      return { gr: `GR ${eStr}${nStr}`, eastPart: eStr, northPart: nStr };
    }

    function convert() {
      let lat = parseDMS(document.getElementById("lat").value);
      let lon = parseDMS(document.getElementById("lon").value);

      if (isNaN(lat) || isNaN(lon)) {
        document.getElementById("output").innerHTML = "Invalid coordinates!";
        return;
      }

      let kandawalaCoords = proj4(kandawala, [lon, lat]);
      let sld99Coords = proj4(sld99, [lon, lat]);
      let utmCoords = proj4(utm44n, [lon, lat]);

      let precision = document.querySelector('input[name="gr"]:checked').value;
      let gr = makeGR(kandawalaCoords[0], kandawalaCoords[1], parseInt(precision));

      let gmap = `https://www.google.com/maps?q=${lat},${lon}`;

      document.getElementById("output").innerHTML = `
        <b>Kandawala Grid:</b><br>
        Easting: ${kandawalaCoords[0].toFixed(0)} m → ${gr.eastPart}<br>
        Northing: ${kandawalaCoords[1].toFixed(0)} m → ${gr.northPart}<br>
        Grid Reference (${precision}-figure): <b>${gr.gr}</b><br><br>

        <b>SLD99 Grid:</b> E ${sld99Coords[0].toFixed(0)} m, N ${sld99Coords[1].toFixed(0)} m<br>
        <b>UTM 44N:</b> E ${utmCoords[0].toFixed(0)} m, N ${utmCoords[1].toFixed(0)} m<br><br>

        <a href="${gmap}" target="_blank">View on Google Maps</a>
      `;
    }
  </script>
</body>
</html>
