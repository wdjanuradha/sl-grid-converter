<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sri Lanka Grid Converter — Tactical Tool</title>
<meta name="description" content="Convert Lat/Lon to Kandawala (EPSG:5235), SLD99 (EPSG:5234), UTM 44N with military grid (4/6/8-figure) and reverse GR → Lat/Lon."/>

<script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.min.js"></script>

<style>
:root{
--bg1:#05060a; --bg2:#071028; --card:#081426; --glass:rgba(255,255,255,0.03);
--accent:#6bd6ff; --accent-2:#7b6bff; --muted:#9fb0c8; --success:#5ee0a8;
--radius:12px; --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color: #e9f3ff;background: radial-gradient(1200px 600px at 10% 10%, rgba(83,126,255,0.06), transparent), linear-gradient(180deg,var(--bg1),var(--bg2));}
.app{max-width:1000px;margin:28px auto;padding:20px}

.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:16px;padding:18px;box-shadow: 0 8px 30px rgba(3,10,20,0.6);} 
header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
.logo{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#021028;font-weight:800;box-shadow:0 6px 18px rgba(107,214,255,0.08) inset}
h1{font-size:18px;margin:0}
p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

.grid{display:grid;gap:12px}
.row{display:flex;gap:12px;align-items:center}
.cols-2{grid-template-columns:1fr 380px}
.cols-3{grid-template-columns:repeat(3,1fr)}
label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

input[type=text], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
.controls{display:flex;gap:10px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021028;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

.output{display:grid;gap:12px;margin-top:14px}
.card-small{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:10px}

.value{font-family:var(--mono);font-size:16px;color:#dff6ff}
.label{font-size:12px;color:var(--muted)}
.gr{font-family:var(--mono);font-size:20px;color:var(--accent);font-weight:800}

.muted{color:var(--muted);font-size:13px}
.small{font-size:12px;color:var(--muted)}

.actions{display:flex;gap:8px;margin-top:8px}
.chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px}

footer{margin-top:14px;color:var(--muted);font-size:13px}

@media (max-width:880px){.cols-2{grid-template-columns:1fr} .cols-3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <header>
      <div class="logo">SL</div>
      <div>
        <h1>Sri Lanka Grid Converter — Tactical</h1>
        <p class="lead">Forward and reverse Grid Reference conversion with map preview.</p>
      </div>
    </header>

    <div class="grid cols-2">
      <div>
        <div class="grid">
          <!-- Forward Conversion -->
          <div>
            <label class="small">Latitude (DD or DMS)</label>
            <input id="lat" type="text" placeholder="e.g. 8.597475 or 8°35'50.91&quot;N" />
          </div>
          <div>
            <label class="small">Longitude (DD or DMS)</label>
            <input id="lon" type="text" placeholder="e.g. 80.483883 or 80°29'1.98&quot;E" />
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
            <div style="flex:1">
              <label class="small">Grid Reference Precision</label>
              <div class="row" style="flex-wrap:wrap">
                <label class="chip"><input type="radio" name="precision" value="4"> 4‑figure</label>
                <label class="chip"><input type="radio" name="precision" value="6" checked> 6‑figure</label>
                <label class="chip"><input type="radio" name="precision" value="8"> 8‑figure</label>
              </div>
            </div>
            <div style="min-width:140px">
              <label class="small">Format</label>
              <select id="format">
                <option value="kandawala">Kandawala (EPSG:5235)</option>
                <option value="sld99">SLD99 (EPSG:5234)</option>
                <option value="utm">UTM 44N (EPSG:32644)</option>
              </select>
            </div>
          </div>

          <div class="controls" style="margin-top:8px">
            <button id="convert" class="btn">Convert</button>
            <button id="clear" class="btn ghost">Clear</button>
            <div class="small" style="margin-left:auto">Inputs accept <strong>decimal</strong> or <strong>DMS</strong></div>
          </div>

          <div class="small muted">Examples of DMS: <code>8°35'50.91"N</code> or <code>8 35 50.91 N</code> or <code>8:35:50.91N</code></div>

          <!-- Reverse Conversion -->
          <div class="card-small" style="margin-top:12px;">
            <div class="label">Reverse Grid → Lat/Lon</div>
            <input id="input-gr" type="text" placeholder="Enter 4, 6, or 8‑figure GR" style="margin-top:6px"/>
            <select id="gr-type" style="margin-top:6px">
              <option value="kandawala">Kandawala (EPSG:5235)</option>
              <option value="sld99">SLD99 (EPSG:5234)</option>
            </select>
            <button id="convert-gr" class="btn" style="margin-top:6px">Locate on Map</button>
            <div id="gr-output" class="small muted" style="margin-top:6px">Lat/Lon will appear here</div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card-small">
          <div class="label">Quick actions</div>
          <div class="actions">
            <button id="copy-gr" class="btn ghost" title="Copy last GR">Copy last GR</button>
            <button id="copy-xy" class="btn ghost" title="Copy full E,N">Copy E,N</button>
            <button id="copy-gmap" class="btn ghost" title="Copy Google Maps link">Copy Maps link</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0" />
          <div class="label">Map preview</div>
          <div id="mapwrap" style="margin-top:8px;border-radius:8px;overflow:hidden;background:#071425;height:220px;display:flex;align-items:center;justify-content:center;color:var(--muted)">No point yet</div>
        </div>
      </aside>
    </div>

    <div class="output">
      <div id="out-wgs" class="card-small">
        <div class="label">WGS84 Input</div>
        <div class="value" id="wgs-lat">—</div>
        <div class="small muted" id="wgs-lon">—</div>
      </div>
      <div id="out-grids" class="grid cols-3"></div>
    </div>

    <footer>
      <div class="small muted">Built with <a href="https://proj4js.org/" target="_blank">proj4js</a>. Forward & Reverse GR conversion ready for tactical use.</div>
    </footer>
  </div>
</div>

<script>
// ------------------- Projection definitions -------------------
proj4.defs("EPSG:5235","+proj=tmerc +lat_0=7 +lon_0=80.77171333333333 +k=0.9999238418 +x_0=200000 +y_0=200000 +a=6377276.345 +rf=300.8017 +units=m +no_defs +towgs84=-97,787,86,0,0,0,0");
proj4.defs("EPSG:5234","+proj=tmerc +lat_0=7 +lon_0=80.77171333333333 +k=0.9999238418 +x_0=200000 +y_0=200000 +ellps=GRS80 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");
proj4.defs("EPSG:32644","+proj=utm +zone=44 +datum=WGS84 +units=m +no_defs");

// ------------------- Utilities -------------------
function parseDMS(input){
  if(!input && input!==0) return NaN;
  const s=String(input).trim();
  if(/^[-+]?\d+(\.\d+)?$/.test(s)) return parseFloat(s);
  const d=s.match(/^(\d{1,3})(?:°|\s|:)?\s*(\d{1,2})?(?:'|\s|:)?\s*(\d{1,2}(\.\d+)?)?\s*["]?\s*([NSEWnsew])?$/);
  if(!d) return NaN;
  const deg=parseFloat(d[1])||0;
  const min=d[2]?parseFloat(d[2]):0;
  const sec=d[3]?parseFloat(d[3]):0;
  const dir=d[5]?d[5].toUpperCase():null;
  let dd=Math.abs(deg)+(min/60)+(sec/3600);
  if(deg<0) dd=-dd;
  if(dir){ if(dir==='S'||dir==='W') dd=-Math.abs(dd);}
  return dd;
}
function fmt(n,dp=0){ if(!isFinite(n)) return '—'; return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp}); }

// ------------------- Grid Reference Logic -------------------
function makeGridRef(easting,northing,figures){
  const d=figures/2;
  const divisor = Math.pow(10,5-d); // 1000,100,10
  const falseE = 200000;
  const falseN = 200000;
  const ePartNum = Math.floor((easting-falseE)/divisor);
  const nPartNum = Math.floor((northing-falseN)/divisor);
  const ePart = String(ePartNum).padStart(d,'0');
  const nPart = String(nPartNum).padStart(d,'0');
  return {gr:`GR ${ePart}${nPart}`,ePart,nPart,d};
}

// ------------------- Map Helpers -------------------
function gmapLink(lat,lon){ return `https://maps.google.com/?q=${lat},${lon}`; }
function gmapEmbed(lat,lon){ return `https://maps.google.com/maps?q=${lat},${lon}&output=embed`; }

const el=id=>document.getElementById(id);
const outWgsLat=el('wgs-lat');
const outWgsLon=el('wgs-lon');
const outGrids=el('out-grids');
const mapWrap=el('mapwrap');
let last={gr:'',easting:null,northing:null,gmap:''};

function clear(){
  el('lat').value=''; el('lon').value=''; outWgsLat.textContent='—'; outWgsLon.textContent='—';
  outGrids.innerHTML=''; mapWrap.textContent='No point yet'; mapWrap.style.background='';
  last={gr:'',easting:null,northing:null,gmap:''};
}
function copyToClipboard(text){ navigator.clipboard.writeText(text).catch(()=>alert('Copy failed — copy manually')); }
function renderMap(lat,lon){ mapWrap.innerHTML=`<iframe title="map" width="100%" height="100%" frameborder="0" style="border:0" src="${gmapEmbed(lat,lon)}" allowfullscreen></iframe>`; }

// ------------------- Forward Conversion -------------------
function convert(){
  const lat=parseDMS(el('lat').value.trim());
  const lon=parseDMS(el('lon').value.trim());
  if(!isFinite(lat)||!isFinite(lon)){alert('Enter valid Latitude and Longitude'); return;}
  const kand=proj4('EPSG:4326','EPSG:5235',[lon,lat]);
  const sld=proj4('EPSG:4326','EPSG:5234',[lon,lat]);
  const utm=proj4('EPSG:4326','EPSG:32644',[lon,lat]);
  const figures=parseInt(document.querySelector('input[name="precision"]:checked').value,10);
  const kandGr=makeGridRef(Math.round(kand[0]),Math.round(kand[1]),figures);

  outGrids.innerHTML='';
  function cardHTML(title,tag,easting,northing,grObj,lat,lon){
    return `<div class="card-small">
      <div class="label">${title} <span class="small muted">${tag}</span></div>
      <div style="margin-top:8px">
        <div class="label">Easting</div>
        <div class="value">${fmt(easting,0)} m → <span class="gr">${grObj?grObj.ePart:'—'}</span></div>
        <div class="label" style="margin-top:6px">Northing</div>
        <div class="value">${fmt(northing,0)} m → <span class="gr">${grObj?grObj.nPart:'—'}</span></div>
        <div style="margin-top:8px"><span class="label">Grid Reference (${figures}-figure)</span>
          <div class="gr">${grObj?grObj.gr:'—'}</div></div>
        <div style="margin-top:8px" class="small muted"> <a target="_blank" href="${gmapLink(lat,lon)}">Open in Google Maps</a> </div>
      </div></div>`;
  }
  outGrids.insertAdjacentHTML('beforeend',cardHTML('Kandawala / Sri Lanka Grid','EPSG:5235',kand[0],kand[1],kandGr,lat,lon));
  outGrids.insertAdjacentHTML('beforeend',cardHTML('SLD99 / Sri Lanka Grid 1999','EPSG:5234',sld[0],sld[1],null,lat,lon));
  outGrids.insertAdjacentHTML('beforeend',cardHTML('UTM Zone 44N (WGS84)','EPSG:32644',utm[0],utm[1],null,lat,lon));

  outWgsLat.textContent=`Lat ${lat.toFixed(6)}`; outWgsLon.textContent=`Lon ${lon.toFixed(6)}`;
  renderMap(lat,lon);

  last.easting=Math.round(kand[0]); last.northing=Math.round(kand[1]); last.gr=kandGr.gr; last.gmap=gmapLink(lat,lon);
  el('copy-gr').onclick=()=>{ if(last.gr) copyToClipboard(last.gr); else alert('No GR'); };
  el('copy-xy').onclick=()=>{ if(last.easting!==null) copyToClipboard(`${last.easting}, ${last.northing}`); else alert('No coordinates'); };
  el('copy-gmap').onclick=()=>{ if(last.gmap) copyToClipboard(last.gmap); else alert('No map link'); };
}

// ------------------- Reverse GR Conversion -------------------
function reverseGR(){
  const gr=el('input-gr').value.trim();
  if(!gr.match(/^\d{4,8}$/)){alert('Enter valid 4,6,8 figure GR'); return;}
  const figures = gr.length;
  const d = figures / 2;
  const ePart = parseInt(gr.substring(0,d),10);
  const nPart = parseInt(gr.substring(d),10);

  const falseE = 200000;
  const falseN = 200000;
  const divisor = Math.pow(10,5-d); // spacing of grid square
  const easting = falseE + ePart*divisor + divisor/2;
  const northing = falseN + nPart*divisor + divisor/2;

  const type = el('gr-type').value;
  const proj = (type==='kandawala')?'EPSG:5235':'EPSG:5234';
  const [lon,lat] = proj4(proj,'EPSG:4326',[easting,northing]);

  el('gr-output').textContent=`Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
  renderMap(lat,lon);

  last.easting = Math.round(easting);
  last.northing = Math.round(northing);
  last.gr = gr;
  last.gmap = gmapLink(lat,lon);
}

// ------------------- Event Listeners -------------------
el('convert').addEventListener('click',convert);
el('clear').addEventListener('click',clear);
el('convert-gr').addEventListener('click',reverseGR);

clear();
</script>
</body>
</html>
